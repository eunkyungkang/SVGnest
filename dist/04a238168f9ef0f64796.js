function toClipperCoordinates(e){for(var i=[],t=0;t<e.length;t++)i.push({X:e[t].x,Y:e[t].y});return i}function toNestCoordinates(e,i){for(var t=[],r=0;r<e.length;r++)t.push({x:e[r].X/i,y:e[r].Y/i});return t}function rotatePolygon(e,i){for(var t=[],r=i*Math.PI/180,l=0;l<e.length;l++){var o=e[l].x,n=e[l].y,p=o*Math.cos(r)-n*Math.sin(r),a=o*Math.sin(r)+n*Math.cos(r);t.push({x:p,y:a})}if(e.children&&e.children.length>0){t.children=[];for(var h=0;h<e.children.length;h++)t.children.push(rotatePolygon(e.children[h],i))}return t}function PlacementWorker(e,i,t,r,l,o){this.binPolygon=e,this.paths=i,this.ids=t,this.rotations=r,this.config=l,this.nfpCache=o||{},this.placePaths=function(e){var i,t,r,l,o,n,p=global.env.self;if(!p.binPolygon)return null;var a=[];for(i=0;i<e.length;i++){var h=rotatePolygon(e[i],e[i].rotation);h.rotation=e[i].rotation,h.source=e[i].source,h.id=e[i].id,a.push(h)}e=a;for(var f,s,c=[],g=0,y=Math.abs(GeometryUtil.polygonArea(p.binPolygon));e.length>0;){var u=[],C=[];for(g+=1,i=0;i<e.length;i++){n=e[i],f=JSON.stringify({A:-1,B:n.id,inside:!0,Arotation:0,Brotation:n.rotation});var d=p.nfpCache[f];if(d&&0!=d.length){var b=!1;for(t=0;t<u.length;t++)if(f=JSON.stringify({A:u[t].id,B:n.id,inside:!1,Arotation:u[t].rotation,Brotation:n.rotation}),!(s=p.nfpCache[f])){b=!0;break}if(!b){var P=null;if(0!=u.length){var x=[];for(t=0;t<d.length;t++)x.push(toClipperCoordinates(d[t]));ClipperLib.JS.ScaleUpPaths(x,p.config.clipperScale);var v=new ClipperLib.Clipper,L=new ClipperLib.Paths;for(t=0;t<u.length;t++)if(f=JSON.stringify({A:u[t].id,B:n.id,inside:!1,Arotation:u[t].rotation,Brotation:n.rotation}),s=p.nfpCache[f])for(r=0;r<s.length;r++){var S=toClipperCoordinates(s[r]);for(l=0;l<S.length;l++)S[l].X+=C[t].x,S[l].Y+=C[t].y;ClipperLib.JS.ScaleUpPath(S,p.config.clipperScale),S=ClipperLib.Clipper.CleanPolygon(S,1e-4*p.config.clipperScale);var A=Math.abs(ClipperLib.Clipper.Area(S));S.length>2&&A>.1*p.config.clipperScale*p.config.clipperScale&&v.AddPath(S,ClipperLib.PolyType.ptSubject,!0)}if(v.Execute(ClipperLib.ClipType.ctUnion,L,ClipperLib.PolyFillType.pftNonZero,ClipperLib.PolyFillType.pftNonZero)){var w=new ClipperLib.Paths;if((v=new ClipperLib.Clipper).AddPaths(L,ClipperLib.PolyType.ptClip,!0),v.AddPaths(x,ClipperLib.PolyType.ptSubject,!0),v.Execute(ClipperLib.ClipType.ctDifference,w,ClipperLib.PolyFillType.pftNonZero,ClipperLib.PolyFillType.pftNonZero)){for(w=ClipperLib.Clipper.CleanPolygons(w,1e-4*p.config.clipperScale),t=0;t<w.length;t++)A=Math.abs(ClipperLib.Clipper.Area(w[t])),(w[t].length<3||A<.1*p.config.clipperScale*p.config.clipperScale)&&(w.splice(t,1),t--);if(w&&0!=w.length){var m=[];for(t=0;t<w.length;t++)m.push(toNestCoordinates(w[t],p.config.clipperScale));w=m;var M,N,T=null,B=null,U=null;for(t=0;t<w.length;t++)if(M=w[t],!(Math.abs(GeometryUtil.polygonArea(M))<2))for(r=0;r<M.length;r++){var k=[];for(l=0;l<u.length;l++)for(o=0;o<u[l].length;o++)k.push({x:u[l][o].x+C[l].x,y:u[l][o].y+C[l].y});for(N={x:M[r].x-n[0].x,y:M[r].y-n[0].y,id:n.id,rotation:n.rotation,nfp:L},l=0;l<n.length;l++)k.push({x:n[l].x+N.x,y:n[l].y+N.y});var J=GeometryUtil.getPolygonBounds(k);A=2*J.width+J.height,(null===B||A<B||GeometryUtil.almostEqual(B,A)&&(null===U||N.x<U))&&(B=A,T=J.width,P=N,U=N.x)}P&&(u.push(n),C.push(P))}}}}else{for(t=0;t<d.length;t++)for(r=0;r<d[t].length;r++)(null===P||d[t][r].x-n[0].x<P.x)&&(P={x:d[t][r].x-n[0].x,y:d[t][r].y-n[0].y,id:n.id,rotation:n.rotation});C.push(P),u.push(n)}}}}for(T&&(g+=T/y),i=0;i<u.length;i++){var F=e.indexOf(u[i]);F>=0&&e.splice(F,1)}if(!(C&&C.length>0))break;c.push(C)}return{placements:c,fitness:g+=2*e.length,paths:e,area:y}}}function alert(e){console.log("alert: ",e)}("undefined"!=typeof window?window:self).PlacementWorker=PlacementWorker;