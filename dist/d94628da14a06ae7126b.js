/*! For license information please see d94628da14a06ae7126b.js.LICENSE.txt */
!function(e){"use strict";function t(e,t,n){this.config=n||{populationSize:10,mutationRate:10,rotations:4},this.binBounds=GeometryUtil.getPolygonBounds(t);for(var r=[],o=0;o<e.length;o++)r.push(this.randomAngle(e[o]));for(this.population=[{placement:e,rotation:r}];this.population.length<n.populationSize;){var i=this.mutate(this.population[0]);this.population.push(i)}}window.SvgNest=new function(){var e=null;this.style=null;var n=null,r=null,o=null,i=null,l=null,a={},s={clipperScale:1e7,curveTolerance:.3,spacing:0,rotations:4,populationSize:10,mutationRate:10,useHoles:!1,exploreConcave:!1};this.working=!1;var p=null,h=null,u=null,c=0;this.parsesvg=function(t){return this.stop(),o=null,i=null,r=null,e=SvgParser.load(t),this.style=SvgParser.getStyle(),e=SvgParser.clean(),r=this.getParts(e.childNodes),e},this.setbin=function(t){e&&(o=t)},this.config=function(e){return e?(e.curveTolerance&&!GeometryUtil.almostEqual(parseFloat(e.curveTolerance),0)&&(s.curveTolerance=parseFloat(e.curveTolerance)),"spacing"in e&&(s.spacing=parseFloat(e.spacing)),e.rotations&&parseInt(e.rotations)>0&&(s.rotations=parseInt(e.rotations)),e.populationSize&&parseInt(e.populationSize)>2&&(s.populationSize=parseInt(e.populationSize)),e.mutationRate&&parseInt(e.mutationRate)>0&&(s.mutationRate=parseInt(e.mutationRate)),"useHoles"in e&&(s.useHoles=!!e.useHoles),"exploreConcave"in e&&(s.exploreConcave=!!e.exploreConcave),SvgParser.config({tolerance:s.curveTolerance}),h=null,a={},i=null,p=null,s):s},this.start=function(t,a){if(!e||!o)return!1;var p=(n=Array.prototype.slice.call(e.childNodes)).indexOf(o);if(p>=0&&n.splice(p,1),function e(t,n,r){for(var o=0;o<t.length;o++){var i=r(t[o],n);1==i.length&&Array.prototype.splice.apply(t[o],[0,t[o].length].concat(i[0])),t[o].childNodes&&t[o].childNodes.length>0&&e(t[o].childNodes,-n,r)}}(r=this.getParts(n.slice(0)),.5*s.spacing,this.polygonOffset.bind(this)),i=SvgParser.polygonify(o),!(i=this.cleanPolygon(i))||i.length<3)return!1;if(l=GeometryUtil.getPolygonBounds(i),s.spacing>0){var h=this.polygonOffset(i,-.5*s.spacing);1==h.length&&(i=h.pop())}i.id=-1;for(var g=i[0].x,f=i[0].x,y=i[0].y,v=i[0].y,d=1;d<i.length;d++)i[d].x>g?g=i[d].x:i[d].x<f&&(f=i[d].x),i[d].y>y?y=i[d].y:i[d].y<v&&(v=i[d].y);for(d=0;d<i.length;d++)i[d].x-=f,i[d].y-=v;for(i.width=g-f,i.height=y-v,GeometryUtil.polygonArea(i)>0&&i.reverse(),d=0;d<r.length;d++){var m=r[d][0],P=r[d][r[d].length-1];(m==P||GeometryUtil.almostEqual(m.x,P.x)&&GeometryUtil.almostEqual(m.y,P.y))&&r[d].pop(),GeometryUtil.polygonArea(r[d])>0&&r[d].reverse()}var S=this;this.working=!1,u=setInterval((function(){S.working||(S.launchWorkers.call(S,r,i,s,t,a),S.working=!0),t(c)}),100)},this.launchWorkers=function(e,n,r,o,i){var l,s;if(null===p){var u=e.slice(0);u.sort((function(e,t){return Math.abs(GeometryUtil.polygonArea(t))-Math.abs(GeometryUtil.polygonArea(e))})),p=new t(u,n,r)}var g=null;for(l=0;l<p.population.length;l++)if(!p.population[l].fitness){g=p.population[l];break}null===g&&(p.generation(),g=p.population[1]);var f=g.placement,y=g.rotation,v=[];for(l=0;l<f.length;l++)v.push(f[l].id),f[l].rotation=y[l];var d,m=[],P={};for(l=0;l<f.length;l++){var S=f[l];for(d={A:n.id,B:S.id,inside:!0,Arotation:0,Brotation:y[l]},a[JSON.stringify(d)]?P[JSON.stringify(d)]=a[JSON.stringify(d)]:m.push({A:n,B:S,key:d}),s=0;s<l;s++){var b=f[s];d={A:b.id,B:S.id,inside:!1,Arotation:y[s],Brotation:y[l]},a[JSON.stringify(d)]?P[JSON.stringify(d)]=a[JSON.stringify(d)]:m.push({A:b,B:S,key:d})}}a=P;var A=new PlacementWorker(n,f.slice(0),v,y,r,a),x=new Parallel(m,{env:{binPolygon:n,searchEdges:r.exploreConcave,useHoles:r.useHoles},evalPath:"util/eval.js"});x.require("matrix.js"),x.require("geometryutil.js"),x.require("placementworker.js"),x.require("clipper.js");var U=this,C=0;x._spawnMapWorker=function(e,t,n,r,o){return c=C++/m.length,Parallel.prototype._spawnMapWorker.call(x,e,t,n,r,o)},x.map((function(e){if(!e||0==e.length)return null;var t,n=global.env.searchEdges,r=global.env.useHoles,o=rotatePolygon(e.A,e.key.Arotation),i=rotatePolygon(e.B,e.key.Brotation);if(e.key.inside)if((t=GeometryUtil.isRectangle(o,.001)?GeometryUtil.noFitPolygonRectangle(o,i):GeometryUtil.noFitPolygon(o,i,!0,n))&&t.length>0)for(var l=0;l<t.length;l++)GeometryUtil.polygonArea(t[l])>0&&t[l].reverse();else u("NFP Warning: ",e.key);else{if(t=n?GeometryUtil.noFitPolygon(o,i,!1,n):function(e,t){var n=c(e);ClipperLib.JS.ScaleUpPath(n,1e7);var r=c(t);ClipperLib.JS.ScaleUpPath(r,1e7);for(var o=0;o<r.length;o++)r[o].X*=-1,r[o].Y*=-1;var i,l=ClipperLib.Clipper.MinkowskiSum(n,r,!0),a=null;for(o=0;o<l.length;o++){var s=g(l[o],1e7),p=GeometryUtil.polygonArea(s);(null===a||a>p)&&(i=s,a=p)}for(o=0;o<i.length;o++)i[o].x+=t[0].x,i[o].y+=t[0].y;return[i]}(o,i),!t||0==t.length)return u("NFP Error: ",e.key),u("A: ",JSON.stringify(o)),u("B: ",JSON.stringify(i)),null;for(l=0;l<t.length;l++)if((!n||0==l)&&Math.abs(GeometryUtil.polygonArea(t[l]))<Math.abs(GeometryUtil.polygonArea(o)))return u("NFP Area Error: ",Math.abs(GeometryUtil.polygonArea(t[l])),e.key),u("NFP:",JSON.stringify(t[l])),u("A: ",JSON.stringify(o)),u("B: ",JSON.stringify(i)),t.splice(l,1),null;if(0==t.length)return null;for(l=0;l<t.length;l++)GeometryUtil.polygonArea(t[l])>0&&t[l].reverse(),l>0&&GeometryUtil.pointInPolygon(t[l][0],t[0])&&GeometryUtil.polygonArea(t[l])<0&&t[l].reverse();if(r&&o.childNodes&&o.childNodes.length>0){var a=GeometryUtil.getPolygonBounds(i);for(l=0;l<o.childNodes.length;l++){var s=GeometryUtil.getPolygonBounds(o.childNodes[l]);if(s.width>a.width&&s.height>a.height){var p=GeometryUtil.noFitPolygon(o.childNodes[l],i,!0,n);if(p&&p.length>0)for(var h=0;h<p.length;h++)GeometryUtil.polygonArea(p[h])<0&&p[h].reverse(),t.push(p[h])}}}}function u(){"undefined"!=typeof console&&console.log.apply(console,arguments)}function c(e){for(var t=[],n=0;n<e.length;n++)t.push({X:e[n].x,Y:e[n].y});return t}function g(e,t){for(var n=[],r=0;r<e.length;r++)n.push({x:e[r].X/t,y:e[r].Y/t});return n}return{key:e.key,value:t}})).then((function(t){if(t)for(var r=0;r<t.length;r++){var o=t[r];if(o){var l=JSON.stringify(o.key);a[l]=o.value}}A.nfpCache=a;var s=new Parallel([f.slice(0)],{env:{self:A},evalPath:"util/eval.js"});s.require("clipper.js"),s.require("matrix.js"),s.require("geometryutil.js"),s.require("placementworker.js"),s.map(A.placePaths).then((function(t){if(t&&0!=t.length){g.fitness=t[0].fitness;for(var r=t[0],o=1;o<t.length;o++)t[o].fitness<r.fitness&&(r=t[o]);if(!h||r.fitness<h.fitness){h=r;var l=0,a=0,s=f.length,p=0;for(o=0;o<h.placements.length;o++){a+=Math.abs(GeometryUtil.polygonArea(n));for(var u=0;u<h.placements[o].length;u++)l+=Math.abs(GeometryUtil.polygonArea(e[h.placements[o][u].id])),p++}i(U.applyPlacement(h.placements),l/a,p,s)}else i();U.working=!1}}),(function(e){console.log(e)}))}),(function(e){console.log(e)}))},this.getParts=function(e){var t,n=[],r=e.length;for(t=0;t<r;t++){var o=SvgParser.polygonify(e[t]);(o=this.cleanPolygon(o))&&o.length>2&&Math.abs(GeometryUtil.polygonArea(o))>s.curveTolerance*s.curveTolerance&&(o.source=t,n.push(o))}return function e(t,n){var r,o,i=[],l=n||0;for(r=0;r<t.length;r++){var a=t[r],s=!1;for(o=0;o<t.length;o++)if(o!=r&&!0===GeometryUtil.pointInPolygon(a[0],t[o])){t[o].children||(t[o].children=[]),t[o].children.push(a),a.parent=t[o],s=!0;break}s||i.push(a)}for(r=0;r<t.length;r++)i.indexOf(t[r])<0&&(t.splice(r,1),r--);for(r=0;r<i.length;r++)i[r].id=l,l++;for(r=0;r<i.length;r++)i[r].children&&(l=e(i[r].children,l));return l}(n),n},this.polygonOffset=function(e,t){if(!t||0==t||GeometryUtil.almostEqual(t,0))return e;var n=this.svgToClipper(e),r=new ClipperLib.ClipperOffset(2,s.curveTolerance*s.clipperScale);r.AddPath(n,ClipperLib.JoinType.jtRound,ClipperLib.EndType.etClosedPolygon);var o=new ClipperLib.Paths;r.Execute(o,t*s.clipperScale);for(var i=[],l=0;l<o.length;l++)i.push(this.clipperToSvg(o[l]));return i},this.cleanPolygon=function(e){var t=this.svgToClipper(e),n=ClipperLib.Clipper.SimplifyPolygon(t,ClipperLib.PolyFillType.pftNonZero);if(!n||0==n.length)return null;for(var r=n[0],o=Math.abs(ClipperLib.Clipper.Area(r)),i=1;i<n.length;i++){var l=Math.abs(ClipperLib.Clipper.Area(n[i]));l>o&&(r=n[i],o=l)}var a=ClipperLib.Clipper.CleanPolygon(r,s.curveTolerance*s.clipperScale);return a&&0!=a.length?this.clipperToSvg(a):null},this.svgToClipper=function(e){for(var t=[],n=0;n<e.length;n++)t.push({X:e[n].x,Y:e[n].y});return ClipperLib.JS.ScaleUpPath(t,s.clipperScale),t},this.clipperToSvg=function(e){for(var t=[],n=0;n<e.length;n++)t.push({x:e[n].X/s.clipperScale,y:e[n].Y/s.clipperScale});return t},this.applyPlacement=function(t){var i,a,s,p=[];for(i=0;i<n.length;i++)p.push(n[i].cloneNode(!1));var h=[];for(i=0;i<t.length;i++){var u=e.cloneNode(!1);u.setAttribute("viewBox","0 0 "+l.width+" "+l.height),u.setAttribute("width",l.width+"px"),u.setAttribute("height",l.height+"px");var c=o.cloneNode(!1);for(c.setAttribute("class","bin"),c.setAttribute("transform","translate("+-l.x+" "+-l.y+")"),u.appendChild(c),a=0;a<t[i].length;a++){var g=t[i][a],f=r[g.id],y=document.createElementNS(e.namespaceURI,"g");if(y.setAttribute("transform","translate("+g.x+" "+g.y+") rotate("+g.rotation+")"),y.appendChild(p[f.source]),f.children&&f.children.length>0){var v=m(f.children,!0);for(s=0;s<v.length;s++){var d=p[v[s].source];v[s].hole&&(!d.getAttribute("class")||d.getAttribute("class").indexOf("hole")<0)&&d.setAttribute("class",d.getAttribute("class")+" hole"),y.appendChild(d)}}u.appendChild(y)}h.push(u)}function m(e,t){for(var n=[],r=0;r<e.length;r++)n.push(e[r]),e[r].hole=t,e[r].children&&e[r].children.length>0&&(n=n.concat(m(e[r].children,!t)));return n}return h},this.stop=function(){this.working=!1,u&&clearInterval(u)}},t.prototype.randomAngle=function(e){for(var t=[],n=0;n<Math.max(this.config.rotations,1);n++)t.push(n*(360/this.config.rotations));for(t=function(e){for(var t=e.length-1;t>0;t--){var n=Math.floor(Math.random()*(t+1)),r=e[t];e[t]=e[n],e[n]=r}return e}(t),n=0;n<t.length;n++){var r=GeometryUtil.rotatePolygon(e,t[n]);if(r.width<this.binBounds.width&&r.height<this.binBounds.height)return t[n]}return 0},t.prototype.mutate=function(e){for(var t={placement:e.placement.slice(0),rotation:e.rotation.slice(0)},n=0;n<t.placement.length;n++){var r=Math.random();if(r<.01*this.config.mutationRate){var o=n+1;if(o<t.placement.length){var i=t.placement[n];t.placement[n]=t.placement[o],t.placement[o]=i}}(r=Math.random())<.01*this.config.mutationRate&&(t.rotation[n]=this.randomAngle(t.placement[n]))}return t},t.prototype.mate=function(e,t){var n,r=Math.round(Math.min(Math.max(Math.random(),.1),.9)*(e.placement.length-1)),o=e.placement.slice(0,r),i=e.rotation.slice(0,r),l=t.placement.slice(0,r),a=t.rotation.slice(0,r);for(n=0;n<t.placement.length;n++)s(o,t.placement[n].id)||(o.push(t.placement[n]),i.push(t.rotation[n]));for(n=0;n<e.placement.length;n++)s(l,e.placement[n].id)||(l.push(e.placement[n]),a.push(e.rotation[n]));function s(e,t){for(var n=0;n<e.length;n++)if(e[n].id==t)return!0;return!1}return[{placement:o,rotation:i},{placement:l,rotation:a}]},t.prototype.generation=function(){this.population.sort((function(e,t){return e.fitness-t.fitness}));for(var e=[this.population[0]];e.length<this.population.length;){var t=this.randomWeightedIndividual(),n=this.randomWeightedIndividual(t),r=this.mate(t,n);e.push(this.mutate(r[0])),e.length<this.population.length&&e.push(this.mutate(r[1]))}this.population=e},t.prototype.randomWeightedIndividual=function(e){var t=this.population.slice(0);e&&t.indexOf(e)>=0&&t.splice(t.indexOf(e),1);for(var n=Math.random(),r=0,o=1/t.length,i=o,l=0;l<t.length;l++){if(n>r&&n<i)return t[l];r=i,i+=2*o*((t.length-l)/t.length)}return t[0]}}();